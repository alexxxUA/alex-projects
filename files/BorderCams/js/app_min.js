class ServiceWorker{constructor(){this.swUrl="/sw.js",this.init()}init(){if(navigator.serviceWorker&&!navigator.serviceWorker.controller)return navigator.serviceWorker.register(this.swUrl).then(function(){console.info("Service worker registered")})}}class ProxyParser{constructor(){this.proxyHref="/proxy?url=",this.proxyUrl=`${location.origin}${this.proxyHref}`,this.domParser=new DOMParser}doProxyFetch(e,t=!1){return fetch(`${this.proxyUrl}${e}${t?"&decode=true":""}`).then(e=>e.text())}doPageFetch(e,t=!1){return this.doProxyFetch(e,t).then(this.blockResources).then(this.convertHtmlToDom.bind(this))}blockResources(e){return e.replace(/src=/gm,"x-src=").replace(/href=/gm,"x-href=")}convertHtmlToDom(e){return this.domParser.parseFromString(e,"text/html")}}class BorderCams extends ProxyParser{constructor(){super(),this.camsUrl="https://dpsu.gov.ua/ua/border/",this.textBorderDataUrl="https://www.financnasprava.sk/sk/infoservis/hranicne-priechody",this.camSel={countries:'[data-id="select-country"] option',checkpoints:'[data-id="select-town"] option'},this.textDataSel={borders:"#tblPriechody tbody tr"},this.slugMap={VN:"нємецьке|німецьке|nemecké|nemecke",VN2:"нємецьке|німецьке|nemecké|nemecke",UBLA:"убля|ubľa|ubla",SLME:"селменце|slemence",ZAH:"захонь"},this.favoritePoints=["VN","VN2","UBLA","SLME","ZAH"],this.predefinedPoints=[{slug:"VN2",name:"Ужгород-КПП - Вишнє-Немецьке",src:"https://stream.dpsu.gov.ua:5101/uzhgorod/embed.html?dvr=false&proto=hls&autoplay=true"}],this.translateMap={"звичайний":"priebežne|priebezne"},this.init()}init(){const e=void 0!==window.orientation;document.body.classList.add(e?"mobile":"desktop"),this.renderApp()}async renderApp(){const e=this,[t,r]=await this.getData();Vue.component("border-cams",{data(){const s={camsData:{},favoritePoints:e.favoritePoints,favoriteItems:[],err:null,streamSrc:null,textData:r,textBorderDataUrl:e.textBorderDataUrl};return t?(s.camsData=t,s.favoriteItems=e.predefinedPoints.concat(e.getCamsDataBySlug(t,e.favoritePoints)),s.favoriteItems.length&&(s.streamSrc=s.favoriteItems[0].src)):s.err="Камери тимчасово недоступні 🤕, cпробуйте пізніше.",s},computed:{activeCamData(){let e;if(this.streamSrc){e=this.favoriteItems.find(e=>e.src===this.streamSrc);const t=this.textData[e.slug];t&&Object.keys(t).length&&Object.assign(e,t,{textData:!0})}return e},streamSrcFormatted(){return`javascript:window.location.replace('${this.streamSrc}');`}},methods:{selectCam(e){this.streamSrc=e},onCamLoad(e){e.currentTarget.src!=this.streamSrc&&(e.currentTarget.src=this.streamSrc)},translate(t){let r=t;return Object.keys(e.translateMap).forEach(t=>{const s=new RegExp(e.translateMap[t],"igm");r=r.replace(s,t)}),r}},mounted(){console.log("mounted")},ready(){console.log("ready")},created(){console.log("created")}}),new Vue({el:"#app"})}alphabetSort(e,t,r){return t[e]<r[e]?1:t[e]>r[e]?-1:0}getData(){const e=this.doPageFetch(this.camsUrl,!0).then(this.parseCamsData.bind(this)),t=this.doPageFetch(this.textBorderDataUrl).then(this.parseTextBorderData.bind(this));return Promise.all([e,t])}getCamsDataBySlug(e,t){const r=[];return t.forEach(t=>{let s;const a=Object.keys(e);for(let o=0;o<a.length;o++){const n=e[a[o]].checkpoints;for(let e=0;e<n.length;e++){const a=n[e];if(a.slug===t){r.push(a),s=a;break}}if(s)break}}),r}parseCamsData(e){const t=e.querySelectorAll(this.camSel.countries),r=e.querySelectorAll(this.camSel.checkpoints);if(!t.length||!r.length)return this.error(`${this.camSel.countries} or ${this.camSel.checkpoints} not found on source page!`),null;const s=Array.prototype.reduce.call(t,(e,{value:t,text:r})=>(e[t]={name:r.trim(),checkpoints:[]},e),{});return r.forEach(({value:e,text:t,dataset:r})=>{if(s[e]){const a={name:t,src:this.updateStreamSrc(r.link)},o=this.findSlugsByName(t);o.length&&(a.slug=o[0]),s[e].checkpoints.push(a)}}),s}parseTextBorderData(e){const t=e.querySelectorAll(this.textDataSel.borders);return t&&0!==t.length?[...t].reduce((e,t)=>{const r={name2:"td:nth-child(1)",waitTimeToEU:"td:nth-child(3)",waitTimeToUA:"td:nth-child(6)",note:"td:nth-child(8)",updatedTime:"td:nth-child(9)"},s=Object.keys(r).reduce((e,s)=>(e[s]=t.querySelector(r[s]).innerText.trim(),e),{}),a=this.findSlugsByName(s.name2);return a.length?a.forEach(t=>e[t]=s):this.error(`Slug not found for text data for: "${s.name2}"`),e},{}):(this.error("Text data for SK borders not found."),{})}updateStreamSrc(e){const t=new URL(e);return t.searchParams.get("autoplay")||t.searchParams.set("autoplay",!0),t.searchParams.get("mute")||t.searchParams.set("mute",!0),t.href}findSlugsByName(e){const t=[];return Object.keys(this.slugMap).forEach(r=>{new RegExp(this.slugMap[r],"i").test(e)&&t.push(r)}),t}error(e){console.error(e)}}const sw=new ServiceWorker,borderCams=new BorderCams;